<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<meta name="viewport" content="width=640, user-scalable=no">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" type="text/css" href="css.css">
	<title></title>
</head>
<body>
    <div id="container" class="backgroundM1">
        <div class="mailBack"></div>
        <div class="mailHeadP"></div>
        <div class="content1 content">
            <div id="textMake" class="letter">……</div>
            <div class="picture">
                <img id="imgGet">
            </div>
        </div>
        <div class="mailFront"></div>
    </div>
    <div id="pictureGet" class="pictureGet">
        <div class="tipsPictureGet">生成图片加载中<br/>请稍后(｀・ω・´)</div>
    </div>
</canvas>
<script type="text/javascript" src="//html2canvas.hertzen.com/dist/html2canvas.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/src/dom-to-image.min.js"></script> -->
<script>
    var allM = {
        backgroundM:["backgroundM1","backgroundM2"],
        changeM:["changeM1","changeM2"],
        making:["making1","making2"],
        finish:["finish1","finish2"],
        letter:["letter1","letter2"],
        mailFront:["mailFront1","mailFront2"],
        mailHead:["mailHead1","mailHead2"],
        picture:["picture1","picture2"],
        mailBack:["mailBackDown1","mailBackDown2"],
        fontColor:["color: #e3cb21;","color: #b7711b;"]
    };
    window.onload = function () {
        var re = /"\n+"/i;
        var str = decodeURIComponent(window.location.search);
        var keyValues = str.slice(1).split("&");
        var obj = {};
        keyValues.forEach(function(keyValue){
            var tempArr = keyValue.split("=");
            var key = tempArr[0];
            var value = tempArr[1].indexOf("|") > 0 ? tempArr[1].split("|") : tempArr[1];
            obj[key] = value;
        });
        console.log(obj)
        var text = obj.text || '';
        var url = localStorage.getItem('img');
        if (url === 'undefined') url = ''
        var nowM = parseInt(obj.nowM || 0);
        console.log(text)
        console.log(url)
        console.log(nowM)
        // 判断背景图是否加载完成
        var imgs = []
        function pushImgs(key, type) {
            let img = new Image()
            img.src = 'img/' + allM[key][nowM] + '.' + type
            return img
        }
        imgs.push(pushImgs('backgroundM', 'jpg'))
        imgs.push(pushImgs('mailBack', 'png'))
        imgs.push(pushImgs('mailHead', 'png'))
        imgs.push(pushImgs('letter', 'jpg'))
        imgs.push(pushImgs('picture', 'png'))
        imgs.push(pushImgs('mailFront', 'png'))
        imgs.push((function () {
            let img = new Image()
            img.src = url || ''
            return img
        })())

        $(".backgroundM1").attr('style', 'background: url(img/'+allM.backgroundM[nowM]+'.jpg) no-repeat;background-size: cover;background-position: center;');
        $(".mailBack").attr('style', 'background: url(img/'+allM.mailBack[nowM]+'.png) no-repeat;background-size: contain;background-position: bottom;');
        $(".mailHeadP").attr('style', 'background: url(img/'+allM.mailHead[nowM]+'.png) no-repeat;background-size: contain;');
        $(".letter").attr('style', 'background: url(img/'+allM.letter[nowM]+'.jpg) no-repeat;background-size: contain;');
        $(".picture").attr('style', 'background: url(img/'+allM.picture[nowM]+'.png) no-repeat;background-size: contain;');
        $(".mailFront").attr('style', 'background: url(img/'+allM.mailFront[nowM]+'.png) no-repeat;background-size: contain;background-position: bottom;');
        $('#imgGet').attr('src', url);
        document.getElementById('textMake').innerHTML = text;
        //localStorage.removeItem('img');

        // 判断背景图是否加载完成
        let imgLoad = setInterval(() => {
            for (let i = imgs.length; i--;) {
                if (!imgs[i].complete) return
            }
            clearInterval(imgLoad)
            drawCanvas()
        }, 300)
        function drawCanvas() {
            // // 分设备
            // if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) {
            //     // alert("IOS");
            //     html2canvas(document.getElementById('container'), {
            //         scale: 1
            //     }).then(function (canvas) {
            //         var image = new Image();
            //         image.src = canvas.toDataURL("image/png");
            //         image.style = 'position:fixed;left:0;top:0;z-index: 999;width: 100vw;height: 100vh;'
            //         document.getElementById('pictureGet').appendChild(image);
                    // $('.tipsPictureGet').addClass('hide');
            //     });
            // } else {
            //     // alert("Android");
            //     domtoimage.toPng(document.getElementById("container"))
            //         .then(function (dataUrl) {
            //             var image = new Image();
            //             image.src = dataUrl
            //             image.style = 'position:fixed;left:0;top:0;z-index: 999;width: 100vw;height: 100vh;'
            //             document.getElementById('pictureGet').appendChild(image);
                        // $('.tipsPictureGet').addClass('hide');
            //         })
            //         .catch(function (error) {
            //             console.log(error)
            //             alert('oops, something went wrong!', error);
            //         });
            // }

            html2canvas(document.getElementById('container'),{
                allowTaint: true,
                useCORS: true,
                logging: true,
            }).then(function(canvas) {
                    console.log(canvas);
                    // document.getElementById('pictureGet').appendChild(canvas);
                    // var mycanvas1=document.getElementsByTagName('canvas')[0];
                    // console.log(mycanvas1);
                    var image = new Image();
                    image.src = canvas.toDataURL("image/png");
                    image.style = 'position:fixed;left:0;top:0;z-index: 999;width: 100vw;height: 100vh;'
                    document.getElementById('pictureGet').appendChild(image);
                    console.log(image);
                    $('.tipsPictureGet').addClass('hide');
                })
        }
        // setTimeout(function(){
        //     $('.tipsPictureGet').addClass('hide');
        //     html2canvas(document.body,{
        //         allowTaint: true,
        //         useCORS: true,
        //         logging: true,
        //     }).then(function(canvas) {
        //             console.log(canvas);
        //             document.getElementById('pictureGet').appendChild(canvas);
        //             var mycanvas1=document.getElementsByTagName('canvas')[0];
        //             console.log(mycanvas1);
        //             var image = new Image();
        //             image.src = mycanvas1.toDataURL("image/png");
        //             image.style = 'position:fixed;left:0;top:0;z-index: 999;width: 100vw;height: 100vh;'
        //             document.getElementById('pictureGet').appendChild(image);
        //             console.log(image);
        //         })
        // },10000);
    }
</script>
</body>
</html>